<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sidebar Tests - Automated</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a2e;
            color: #eee;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        h1 {
            color: #D4AF37;
            border-bottom: 2px solid #D4AF37;
            padding-bottom: 0.5rem;
        }
        .summary {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }
        .pass { color: #4CAF50; }
        .fail { color: #f44336; }
        .skip { color: #ff9800; }

        .suite {
            margin: 1.5rem 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        .suite-header {
            background: rgba(255,255,255,0.1);
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .suite-header:hover {
            background: rgba(255,255,255,0.15);
        }
        .suite-body {
            padding: 0.5rem 0;
        }
        .test {
            padding: 0.5rem 1rem 0.5rem 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid transparent;
        }
        .test.pass { border-left-color: #4CAF50; }
        .test.fail { border-left-color: #f44336; background: rgba(244,67,54,0.1); }
        .test-icon {
            width: 20px;
            text-align: center;
        }
        .test-name {
            flex: 1;
        }
        .test-error {
            font-size: 0.85rem;
            color: #f44336;
            padding: 0.5rem 1rem 0.5rem 3rem;
            background: rgba(244,67,54,0.05);
        }

        /* Hidden iframe for testing */
        #testFrame {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 400px;
            height: 300px;
            border: 2px solid #333;
            border-radius: 8px 0 0 0;
            z-index: 1000;
        }
        .hide-frame #testFrame {
            display: none;
        }
        .toggle-frame {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: #D4AF37;
            color: #1a1a2e;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body class="hide-frame">
    <div class="test-container">
        <h1>Sidebar Feature Tests</h1>

        <div class="summary">
            <div class="stat">
                <div class="stat-value pass" id="passCount">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat">
                <div class="stat-value fail" id="failCount">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat" style="margin-left: auto;">
                <div class="stat-value" id="duration">0ms</div>
                <div class="stat-label">Duration</div>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <button class="toggle-frame" onclick="toggleFrame()">Toggle Preview</button>
    <iframe id="testFrame" src="../index.html"></iframe>

    <script>
        // Simple test framework
        const results = { suites: [], passed: 0, failed: 0, total: 0 };
        let currentSuite = null;
        let doc = null;

        function describe(name, fn) {
            currentSuite = { name, tests: [] };
            results.suites.push(currentSuite);
            fn();
        }

        function test(name, fn) {
            const testResult = { name, passed: false, error: null };
            currentSuite.tests.push(testResult);
            results.total++;

            try {
                fn();
                testResult.passed = true;
                results.passed++;
            } catch (e) {
                testResult.error = e.message;
                results.failed++;
            }
        }

        function expect(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeNull() {
                    if (actual !== null) {
                        throw new Error(`Expected null, got ${JSON.stringify(actual)}`);
                    }
                },
                not: {
                    toBeNull() {
                        if (actual === null) {
                            throw new Error(`Expected not null, got null`);
                        }
                    },
                    toBe(expected) {
                        if (actual === expected) {
                            throw new Error(`Expected not ${JSON.stringify(expected)}`);
                        }
                    }
                },
                toContain(expected) {
                    if (!actual || !actual.includes(expected)) {
                        throw new Error(`Expected "${actual}" to contain "${expected}"`);
                    }
                },
                toBeLessThan(expected) {
                    if (actual >= expected) {
                        throw new Error(`Expected ${actual} to be less than ${expected}`);
                    }
                },
                toBeGreaterThanOrEqual(expected) {
                    if (actual < expected) {
                        throw new Error(`Expected ${actual} to be >= ${expected}`);
                    }
                }
            };
        }

        function runTests() {
            const startTime = Date.now();

            // DOM Structure Tests
            describe('DOM Structure', () => {
                test('sidebar element exists', () => {
                    const sidebar = doc.getElementById('sidebar');
                    expect(sidebar).not.toBeNull();
                    expect(sidebar.tagName).toBe('ASIDE');
                });

                test('sidebar has inner container', () => {
                    const inner = doc.querySelector('.sidebar-inner');
                    expect(inner).not.toBeNull();
                });

                test('sidebar has toggle button', () => {
                    const btn = doc.getElementById('sidebarToggle');
                    expect(btn).not.toBeNull();
                    expect(btn.tagName).toBe('BUTTON');
                });

                test('sidebar has India Top 25 button', () => {
                    const btn = doc.getElementById('sidebarIndiaBtn');
                    expect(btn).not.toBeNull();
                    expect(btn.dataset.chart).toBe('india');
                });

                test('sidebar has Global Top 25 button', () => {
                    const btn = doc.getElementById('sidebarGlobalBtn');
                    expect(btn).not.toBeNull();
                    expect(btn.dataset.chart).toBe('global');
                });

                test('sidebar has footer', () => {
                    const footer = doc.querySelector('.sidebar-footer');
                    expect(footer).not.toBeNull();
                });

                test('sidebar footer has share button (Refer to a friend)', () => {
                    const btn = doc.querySelector('.sidebar-footer #shareBtn');
                    expect(btn).not.toBeNull();
                });

                test('sidebar footer has About link', () => {
                    const link = doc.querySelector('.sidebar-footer a[href="about.html"]');
                    expect(link).not.toBeNull();
                });
            });

            describe('Header Menu Button', () => {
                test('hamburger button exists in header', () => {
                    const btn = doc.getElementById('headerMenuBtn');
                    expect(btn).not.toBeNull();
                });

                test('hamburger button is in brand section', () => {
                    const btn = doc.getElementById('headerMenuBtn');
                    const brand = btn.closest('.brand');
                    expect(brand).not.toBeNull();
                });

                test('hamburger button has SVG icon', () => {
                    const btn = doc.getElementById('headerMenuBtn');
                    const svg = btn.querySelector('svg');
                    expect(svg).not.toBeNull();
                });
            });

            describe('Sidebar State', () => {
                test('sidebar starts closed (no open class)', () => {
                    const sidebar = doc.getElementById('sidebar');
                    expect(sidebar.classList.contains('open')).toBe(false);
                });

                test('India button has active class by default', () => {
                    const btn = doc.getElementById('sidebarIndiaBtn');
                    expect(btn.classList.contains('active')).toBe(true);
                });

                test('Global button does not have active class by default', () => {
                    const btn = doc.getElementById('sidebarGlobalBtn');
                    expect(btn.classList.contains('active')).toBe(false);
                });
            });

            describe('Header Cleanup', () => {
                test('no About button in header', () => {
                    const aboutBtn = doc.querySelector('.header .btn-about');
                    expect(aboutBtn).toBeNull();
                });

                test('no Share button in header', () => {
                    const shareBtn = doc.querySelector('.header .btn-share');
                    expect(shareBtn).toBeNull();
                });

                test('chart date still in header', () => {
                    const date = doc.getElementById('chartDate');
                    expect(date).not.toBeNull();
                    expect(date.closest('.header')).not.toBeNull();
                });
            });

            describe('Auth Button', () => {
                test('auth button exists', () => {
                    const btn = doc.querySelector('.auth-btn');
                    // May or may not exist depending on auth setup
                    // Just checking it doesn't throw
                });
            });

            describe('Styling', () => {
                test('sidebar has correct z-index', () => {
                    const sidebar = doc.getElementById('sidebar');
                    const style = window.getComputedStyle(sidebar);
                    const zIndex = parseInt(style.zIndex) || 99;
                    expect(zIndex).toBeLessThan(100);
                });

                test('sidebar positioned below header', () => {
                    const sidebar = doc.getElementById('sidebar');
                    const style = window.getComputedStyle(sidebar);
                    // Header height may be 70px or 80px depending on styling
                    const top = parseInt(style.top);
                    expect(top >= 60 && top <= 90).toBe(true);
                });
            });

            describe('Profile Button', () => {
                test('profile button exists in sidebar', () => {
                    const btn = doc.getElementById('sidebarProfileBtn');
                    expect(btn).not.toBeNull();
                    expect(btn.tagName).toBe('BUTTON');
                });

                test('profile button has SVG icon', () => {
                    const btn = doc.getElementById('sidebarProfileBtn');
                    const svg = btn.querySelector('svg');
                    expect(svg).not.toBeNull();
                });

                test('profile panel exists', () => {
                    const panel = doc.getElementById('profilePanel');
                    expect(panel).not.toBeNull();
                });

                test('profile panel is hidden by default', () => {
                    const panel = doc.getElementById('profilePanel');
                    expect(panel.classList.contains('visible')).toBe(false);
                });

                test('profile panel has back button', () => {
                    const btn = doc.getElementById('profileClose');
                    expect(btn).not.toBeNull();
                });

                test('profile panel has sign out button', () => {
                    const btn = doc.getElementById('profileSignout');
                    expect(btn).not.toBeNull();
                });
            });

            describe('Auth Dropdown', () => {
                test('enabling test mode creates auth dropdown', () => {
                    const win = doc.defaultView;
                    if (typeof win.enableTestMode === 'function') {
                        win.enableTestMode();
                        const dropdown = doc.querySelector('.auth-dropdown');
                        expect(dropdown).not.toBeNull();
                    }
                });

                test('dropdown has Profile option', () => {
                    const profileOption = doc.getElementById('authDropdownProfile');
                    // May be null if test mode not enabled, that's ok
                    if (profileOption) {
                        expect(profileOption.textContent).toContain('Profile');
                    }
                });

                test('dropdown has Sign Out option', () => {
                    const logoutOption = doc.getElementById('authDropdownLogout');
                    if (logoutOption) {
                        expect(logoutOption.textContent).toContain('Sign Out');
                    }
                });
            });

            describe('Logout Cleanup', () => {
                test('logout clears auth tokens', () => {
                    const win = doc.defaultView;
                    if (typeof win.enableTestMode === 'function') {
                        win.enableTestMode();
                    }
                    if (typeof win.logout === 'function') {
                        win.logout();
                        expect(win.localStorage.getItem('tldr-access-token')).toBeNull();
                        expect(win.localStorage.getItem('tldr-user')).toBeNull();
                    }
                });

                test('logout resets auth state (no user in localStorage)', () => {
                    const win = doc.defaultView;
                    // After logout, user should be removed from localStorage
                    expect(win.localStorage.getItem('tldr-user')).toBeNull();
                });

                test('logout clears favorites from localStorage', () => {
                    const win = doc.defaultView;
                    win.localStorage.setItem('tldr-favorites', JSON.stringify([{title: 'Test'}]));
                    if (typeof win.logout === 'function') {
                        win.logout();
                        expect(win.localStorage.getItem('tldr-favorites')).toBeNull();
                    }
                });

                test('logout clears history from localStorage', () => {
                    const win = doc.defaultView;
                    win.localStorage.setItem('tldr-history', JSON.stringify([{title: 'Test'}]));
                    if (typeof win.logout === 'function') {
                        win.logout();
                        expect(win.localStorage.getItem('tldr-history')).toBeNull();
                    }
                });
            });

            const duration = Date.now() - startTime;
            renderResults(duration);
        }

        function renderResults(duration) {
            document.getElementById('passCount').textContent = results.passed;
            document.getElementById('failCount').textContent = results.failed;
            document.getElementById('totalCount').textContent = results.total;
            document.getElementById('duration').textContent = duration + 'ms';

            const container = document.getElementById('results');
            container.innerHTML = results.suites.map(suite => `
                <div class="suite">
                    <div class="suite-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        ${suite.name} (${suite.tests.filter(t => t.passed).length}/${suite.tests.length})
                    </div>
                    <div class="suite-body">
                        ${suite.tests.map(t => `
                            <div class="test ${t.passed ? 'pass' : 'fail'}">
                                <span class="test-icon">${t.passed ? '✓' : '✗'}</span>
                                <span class="test-name">${t.name}</span>
                            </div>
                            ${t.error ? `<div class="test-error">${t.error}</div>` : ''}
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleFrame() {
            document.body.classList.toggle('hide-frame');
        }

        // Wait for iframe to load
        document.getElementById('testFrame').onload = function() {
            doc = this.contentDocument;
            setTimeout(runTests, 500); // Wait for JS to initialize
        };
    </script>
</body>
</html>
