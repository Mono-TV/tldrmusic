#!/bin/bash
# TLDR Music - Pre-commit Hook
# Runs tests and enforces code quality before commits

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo -e "${BOLD}${CYAN}"
echo "╔════════════════════════════════════════╗"
echo "║     TLDR Music - Pre-commit Hook       ║"
echo "╚════════════════════════════════════════╝"
echo -e "${NC}"

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${CYAN}Branch: ${BRANCH}${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
echo -e "${CYAN}Staged files: $(echo "$STAGED_FILES" | wc -l | tr -d ' ')${NC}"
echo ""

# ============================================================
# Check 1: Localhost API URLs (quick check)
# ============================================================
echo -e "${BOLD}▸ Checking for localhost URLs...${NC}"

LOCALHOST_PATTERN="(API_BASE|API_URL).*localhost"
JS_FILES=$(echo "$STAGED_FILES" | grep -E "^(app|auth)\.js$" || true)

if [ -n "$JS_FILES" ]; then
    for FILE in $JS_FILES; do
        if grep -qE "$LOCALHOST_PATTERN" "$FILE" 2>/dev/null; then
            echo -e "${RED}  ✗ ERROR: Found localhost API URL in $FILE${NC}"
            echo ""
            echo -e "${YELLOW}  The frontend must use the production API URL:${NC}"
            echo "    https://tldrmusic-api-401132033262.asia-south1.run.app"
            echo ""
            exit 1
        fi
    done
    echo -e "${GREEN}  ✓ No localhost URLs found${NC}"
else
    echo -e "  ℹ No JS files staged, skipping"
fi

# ============================================================
# Check 2: JavaScript Syntax
# ============================================================
echo -e "\n${BOLD}▸ Checking JavaScript syntax...${NC}"

JS_ALL=$(echo "$STAGED_FILES" | grep -E "\.js$" || true)
JS_ERRORS=0

if [ -n "$JS_ALL" ]; then
    for FILE in $JS_ALL; do
        if [ -f "$FILE" ]; then
            if node --check "$FILE" 2>/dev/null; then
                echo -e "${GREEN}  ✓ $FILE${NC}"
            else
                echo -e "${RED}  ✗ $FILE - syntax error${NC}"
                JS_ERRORS=$((JS_ERRORS + 1))
            fi
        fi
    done
else
    echo -e "  ℹ No JS files staged, skipping"
fi

if [ $JS_ERRORS -gt 0 ]; then
    echo -e "\n${RED}${BOLD}✗ JavaScript syntax errors found. Fix before committing.${NC}"
    exit 1
fi

# ============================================================
# Check 3: Python Syntax
# ============================================================
echo -e "\n${BOLD}▸ Checking Python syntax...${NC}"

PY_FILES=$(echo "$STAGED_FILES" | grep -E "\.py$" || true)
PY_ERRORS=0

if [ -n "$PY_FILES" ]; then
    for FILE in $PY_FILES; do
        if [ -f "$FILE" ]; then
            if python3 -m py_compile "$FILE" 2>/dev/null; then
                echo -e "${GREEN}  ✓ $FILE${NC}"
            else
                echo -e "${RED}  ✗ $FILE - syntax error${NC}"
                PY_ERRORS=$((PY_ERRORS + 1))
            fi
        fi
    done
else
    echo -e "  ℹ No Python files staged, skipping"
fi

if [ $PY_ERRORS -gt 0 ]; then
    echo -e "\n${RED}${BOLD}✗ Python syntax errors found. Fix before committing.${NC}"
    exit 1
fi

# ============================================================
# Check 4: Backend Validation (models, services, routes)
# ============================================================
BACKEND_FILES=$(echo "$STAGED_FILES" | grep -E "^backend/.*\.py$" || true)

if [ -n "$BACKEND_FILES" ]; then
    echo -e "\n${BOLD}▸ Validating backend (models, services, routes)...${NC}"

    if [ -f "scripts/validate-backend.py" ]; then
        # Run backend validation
        if python3 scripts/validate-backend.py 2>&1; then
            echo -e "${GREEN}  ✓ Backend validation passed${NC}"
        else
            echo -e "\n${RED}${BOLD}╔════════════════════════════════════════════════════╗${NC}"
            echo -e "${RED}${BOLD}║  Backend Validation FAILED                         ║${NC}"
            echo -e "${RED}${BOLD}╚════════════════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "${YELLOW}Common issues:${NC}"
            echo "  - Pydantic model field mismatch"
            echo "  - Service using fields that don't exist in model"
            echo "  - Import errors"
            echo ""
            echo -e "${YELLOW}Fix the errors and try again.${NC}"
            exit 1
        fi
    else
        echo -e "  ${YELLOW}ℹ Backend validation script not found, skipping${NC}"
    fi
else
    echo -e "\n${BOLD}▸ Backend validation...${NC}"
    echo -e "  ℹ No backend files staged, skipping"
fi

# ============================================================
# Check 5: Run full test suite (on main branch only)
# ============================================================
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo -e "\n${BOLD}▸ Running full test suite (main branch)...${NC}"

    if [ -f "scripts/run-tests.js" ]; then
        if node scripts/run-tests.js; then
            echo -e "${GREEN}  ✓ All tests passed${NC}"
        else
            echo -e "\n${RED}${BOLD}╔════════════════════════════════════════════════════╗${NC}"
            echo -e "${RED}${BOLD}║  Tests FAILED - Cannot commit to main branch       ║${NC}"
            echo -e "${RED}${BOLD}╚════════════════════════════════════════════════════╝${NC}"
            echo ""
            echo -e "${YELLOW}Options:${NC}"
            echo "  1. Fix the issues and try again"
            echo "  2. Create a feature branch:"
            echo ""
            echo -e "${CYAN}     git stash${NC}"
            echo -e "${CYAN}     git checkout -b feature/your-feature-name${NC}"
            echo -e "${CYAN}     git stash pop${NC}"
            echo -e "${CYAN}     git add . && git commit -m \"WIP: your message\"${NC}"
            echo ""
            echo -e "${YELLOW}  3. Skip tests (not recommended):${NC}"
            echo "     git commit --no-verify"
            echo ""
            exit 1
        fi
    else
        echo -e "  ℹ Test runner not found, skipping"
    fi
else
    echo -e "\n${YELLOW}▸ On feature branch - skipping full test suite${NC}"
    echo -e "  ${YELLOW}Note: Tests must pass before merging to main${NC}"
fi

# ============================================================
# All checks passed
# ============================================================
echo -e "\n${GREEN}${BOLD}════════════════════════════════════════${NC}"
echo -e "${GREEN}${BOLD}  ✓ All pre-commit checks passed!${NC}"
echo -e "${GREEN}${BOLD}════════════════════════════════════════${NC}\n"

exit 0
