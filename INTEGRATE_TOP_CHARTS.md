# Integrate Top Charts from music-harvester

## Overview

New API endpoints are available at music-harvester that provide **YouTube Music-based Top 25 charts** generated by music-conductor. These complement the existing scraper-based charts.

## New Endpoints

**Base URL:** `https://music-harvester-401132033262.asia-south1.run.app/api`

| Endpoint | Description |
|----------|-------------|
| `GET /api/top-charts` | List all available charts |
| `GET /api/top-charts/india` | Top 25 India (YouTube Music) |
| `GET /api/top-charts/global` | Top 25 Global (YouTube Music) |
| `GET /api/top-charts/{region}/youtube-urls` | Just YouTube URLs |

## Response Format

```json
{
  "playlist_id": "top_25_india_20251222",
  "name": "Top 25 India",
  "region": "india",
  "track_count": 25,
  "sources_used": ["youtube_music"],
  "generated_at": "2025-12-22T01:53:09.505937",
  "tracks": [
    {
      "position": 1,
      "title": "Song Title",
      "artist": "Artist Name",
      "youtube_id": "dQw4w9WgXcQ",
      "youtube_url": "https://music.youtube.com/watch?v=dQw4w9WgXcQ",
      "album": "Album Name",
      "artwork_url": "https://lh3.googleusercontent.com/...",
      "aggregate_score": 109.0,
      "sources": ["youtube_music"],
      "source_positions": {"youtube_music": 1}
    }
  ]
}
```

## Integration in app.js

### 1. Add API Constant

```javascript
// Add near other API constants (around line 20)
const TOP_CHARTS_API_BASE = 'https://music-harvester-401132033262.asia-south1.run.app/api/top-charts';
```

### 2. Add Fetch Function

```javascript
// Add new function to fetch YouTube Music charts
async function loadTopCharts(region = 'india') {
    try {
        const response = await fetch(`${TOP_CHARTS_API_BASE}/${region}`);
        if (!response.ok) throw new Error('Failed to fetch top charts');

        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Top charts fetch error:', error);
        return null;
    }
}
```

### 3. Transform to Existing Format

```javascript
// Convert new format to match existing chart structure
function transformTopChartToChartFormat(topChart) {
    return {
        generated_at: topChart.generated_at,
        week: new Date().toISOString().slice(0, 4) + '-W' + getWeekNumber(),
        total_songs: topChart.track_count,
        chart: topChart.tracks.map(track => ({
            rank: track.position,
            title: track.title,
            artist: track.artist,
            youtube_video_id: track.youtube_id,
            artwork_url: track.artwork_url,
            album: track.album,
            score: track.aggregate_score,
            platforms_count: track.sources.length,
            platform_positions: track.source_positions
        }))
    };
}
```

### 4. Add to UI (Optional New Section)

```javascript
// Render Top Charts section
function renderTopChartsSection(topChart) {
    const section = document.createElement('section');
    section.className = 'top-charts-section';
    section.innerHTML = `
        <div class="section-header">
            <h3>ðŸŽµ YouTube Music Top 25</h3>
            <span class="updated-time">Updated: ${new Date(topChart.generated_at).toLocaleDateString()}</span>
        </div>
        <div class="top-charts-list">
            ${topChart.tracks.slice(0, 10).map(track => `
                <div class="song-card" data-video-id="${track.youtube_id}">
                    <div class="song-card-rank">${track.position}</div>
                    <img class="song-card-artwork" src="${track.artwork_url}" alt="${track.title}">
                    <div class="song-card-info">
                        <div class="song-card-title">${track.title}</div>
                        <div class="song-card-artist">${track.artist}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    return section;
}
```

### 5. Add CSS (in style.css)

```css
/* Top Charts Section */
.top-charts-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--surface-color);
    border-radius: 12px;
}

.top-charts-section .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.top-charts-section .updated-time {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.top-charts-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}
```

## Quick Integration (Minimal)

If you just want to use YouTube Music data as a fallback or alternative source:

```javascript
// In loadChartData(), add as fallback
async function loadChartData() {
    try {
        // Existing fetch logic...
        const response = await fetch(`${CHART_API_BASE}/chart/current`);
        // ...
    } catch (error) {
        // Fallback to YouTube Music charts
        console.log('Falling back to YouTube Music charts');
        const topChart = await loadTopCharts('india');
        if (topChart) {
            chartData = transformTopChartToChartFormat(topChart);
            renderChart();
        }
    }
}
```

## Key Differences

| Feature | Existing Charts | New Top Charts |
|---------|-----------------|----------------|
| Source | Multi-platform scraping | YouTube Music |
| Update | Weekly | Daily |
| Data | Rank, score, views, lyrics | Position, YouTube URL, artwork |
| Playback | YouTube ID | Direct YouTube Music URL |

## Testing

```bash
# Test the endpoints
curl https://music-harvester-401132033262.asia-south1.run.app/api/top-charts
curl https://music-harvester-401132033262.asia-south1.run.app/api/top-charts/india
curl https://music-harvester-401132033262.asia-south1.run.app/api/top-charts/global
```

## Questions?

Contact the music-conductor team or check `/docs/TLDR_INTEGRATION.md` in music-conductor repo.
